<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatNix Portal</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .chat-bg { background-color: #f8fafc; }
        .message-in { background-color: white; border-radius: 0.25rem 1.25rem 1.25rem 1.25rem; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .message-out { background-color: #4f46e5; color: white; border-radius: 1.25rem 0.25rem 1.25rem 1.25rem; box-shadow: 0 4px 6px rgba(79, 70, 229, 0.1); }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .recording-pulse { animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        .incoming-call-anim { animation: pulse-indigo 2s infinite; }
        @keyframes pulse-indigo {
            0% { background-color: #1e1b4b; }
            50% { background-color: #312e81; }
            100% { background-color: #1e1b4b; }
        }

        .img-preview { max-width: 200px; border-radius: 0.75rem; cursor: pointer; transition: transform 0.2s; }
        .img-preview:hover { transform: scale(1.02); }

        /* Emoji Picker Styles */
        #emoji-picker {
            display: none;
            position: absolute;
            bottom: 60px;
            right: 0;
            width: 250px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            z-index: 50;
            padding: 10px;
        }
        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 5px;
        }
        .emoji-item {
            cursor: pointer;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            transition: background 0.2s;
            height: 35px;
        }
        .emoji-item:hover { background: #f1f5f9; }
    </style>
</head>
<body class="bg-slate-100 h-screen overflow-hidden flex font-sans text-slate-900">

    <!-- Sidebar -->
    <div id="sidebar" class="w-full md:w-80 border-r border-slate-200 flex flex-col bg-white">
        <div class="p-5 bg-indigo-600 text-white flex justify-between items-center shrink-0">
            <h1 class="text-xl font-bold tracking-tight">ChatNix</h1>
            <div class="flex gap-2">
                <button onclick="switchTab('chats')" title="Messages" class="p-2 rounded-lg hover:bg-indigo-500 transition"><i class="fa-solid fa-message text-sm"></i></button>
                <button onclick="switchTab('search')" title="Find Friends" class="p-2 rounded-lg hover:bg-indigo-500 transition"><i class="fa-solid fa-user-plus text-sm"></i></button>
                <button onclick="switchTab('requests')" title="Requests" class="relative p-2 rounded-lg hover:bg-indigo-500 transition">
                    <i class="fa-solid fa-bell text-sm"></i>
                    <span id="req-badge" class="hidden absolute top-1.5 right-1.5 bg-red-500 w-2 h-2 rounded-full border-2 border-indigo-600"></span>
                </button>
            </div>
        </div>

        <!-- Local Search / Filter -->
        <div class="px-4 py-3 bg-slate-50 border-b border-slate-100 shrink-0">
            <div class="relative">
                <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                <input id="friend-filter" type="text" oninput="filterFriends()" placeholder="Search conversations..." class="w-full pl-9 pr-4 py-2 bg-white border border-slate-200 rounded-xl text-xs outline-none focus:ring-2 focus:ring-indigo-500/20 transition">
            </div>
        </div>

        <div id="list-container" class="flex-1 overflow-y-auto">
            <!-- Dynamic Content -->
        </div>

        <div class="p-4 border-t bg-slate-50 flex items-center gap-3 shrink-0">
            <div id="my-avatar" class="w-10 h-10 rounded-xl bg-indigo-600 text-white flex items-center justify-center font-bold shadow-sm">?</div>
            <div class="flex-1 truncate">
                <div id="my-name" class="text-sm font-bold text-slate-800 truncate">Loading...</div>
                <div class="text-[10px] text-green-500 flex items-center gap-1 font-bold uppercase tracking-wider">
                    <span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span> Online
                </div>
            </div>
            <button onclick="handleLogout()" class="p-2 text-slate-400 hover:text-red-500 transition"><i class="fa-solid fa-power-off"></i></button>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div id="chat-area" class="flex-1 flex flex-col chat-bg relative">
        <div id="no-chat" class="flex-1 flex flex-col items-center justify-center text-slate-300 p-8 text-center">
            <div class="w-24 h-24 bg-white rounded-3xl shadow-sm flex items-center justify-center mb-6">
                <i class="fa-solid fa-comments text-4xl text-slate-200"></i>
            </div>
            <h3 class="text-slate-500 font-bold text-lg">Your Messages</h3>
            <p class="text-slate-400 font-medium text-sm max-w-xs mt-2">Select a conversation or find a friend to start chatting</p>
        </div>

        <div id="active-chat" class="hidden flex flex-col h-full">
            <!-- Chat Header -->
            <div class="p-4 bg-white border-b flex justify-between items-center shadow-sm z-10 shrink-0">
                <div class="flex items-center gap-3">
                    <div id="chat-avatar" class="w-10 h-10 rounded-xl bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold">?</div>
                    <div>
                        <div id="chat-name" class="font-bold text-slate-800">Friend</div>
                        <div id="chat-status" class="text-[10px] text-green-500 flex items-center gap-1 font-bold uppercase tracking-tighter">
                            <span class="w-1.5 h-1.5 bg-green-500 rounded-full"></span> Active
                        </div>
                    </div>
                </div>
                <div class="flex gap-1">
                    <button onclick="startCall()" title="Voice Call" class="w-10 h-10 text-slate-400 rounded-xl hover:bg-indigo-50 hover:text-indigo-600 transition flex items-center justify-center"><i class="fa-solid fa-phone text-sm"></i></button>
                    <button class="w-10 h-10 text-slate-400 rounded-xl hover:bg-slate-100 transition flex items-center justify-center"><i class="fa-solid fa-ellipsis-vertical text-sm"></i></button>
                </div>
            </div>

            <!-- Messages Area -->
            <div id="messages-container" class="flex-1 overflow-y-auto p-6 space-y-4"></div>

            <!-- Typing/Attachment Bar -->
            <div class="p-4 bg-white border-t flex flex-col gap-3 shrink-0">
                <div id="attachment-preview" class="hidden flex items-center gap-2 p-2 bg-slate-50 rounded-xl border border-dashed border-slate-200">
                    <div class="w-10 h-10 bg-indigo-100 rounded-lg flex items-center justify-center text-indigo-600"><i class="fa-solid fa-file"></i></div>
                    <div class="flex-1 text-[10px] font-bold truncate" id="file-name-preview">File.png</div>
                    <button onclick="clearAttachment()" class="p-1.5 text-slate-400 hover:text-red-500"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="flex items-center gap-3">
                    <div class="flex gap-1">
                        <input type="file" id="file-input" class="hidden" onchange="handleFileSelect(event)">
                        <button onclick="document.getElementById('file-input').click()" title="Send Image/File" class="w-10 h-10 bg-slate-100 text-slate-500 rounded-xl hover:bg-indigo-50 hover:text-indigo-600 transition flex items-center justify-center">
                            <i class="fa-solid fa-paperclip text-sm"></i>
                        </button>
                        <button id="mic-btn" title="Hold to record" class="w-10 h-10 bg-slate-100 text-slate-500 rounded-xl hover:bg-indigo-50 hover:text-indigo-600 transition flex items-center justify-center">
                            <i class="fa-solid fa-microphone text-sm"></i>
                        </button>
                    </div>
                    
                    <div class="flex-1 relative">
                        <input id="msg-input" type="text" placeholder="Type a message..." class="w-full bg-slate-100 rounded-xl pl-5 pr-12 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500/20 outline-none border-none transition">
                        
                        <!-- Emoji Trigger -->
                        <button onclick="toggleEmojiPicker()" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-indigo-600 transition">
                            <i class="fa-regular fa-face-smile text-lg"></i>
                        </button>

                        <!-- Emoji Picker Menu -->
                        <div id="emoji-picker" class="animate-fade-in">
                            <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 px-1">Quick Emojis</div>
                            <div class="emoji-grid" id="emoji-grid">
                                <!-- Populated via JS -->
                            </div>
                        </div>
                    </div>

                    <button onclick="sendTextMessage()" class="w-10 h-10 bg-indigo-600 text-white rounded-xl shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition flex items-center justify-center shrink-0">
                        <i class="fa-solid fa-paper-plane text-xs"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Call Overlay -->
    <div id="call-overlay" class="hidden fixed inset-0 bg-indigo-950 flex flex-col items-center justify-center text-white z-[100] animate-fade-in">
        <div class="relative">
            <div id="call-avatar-circle" class="w-32 h-32 rounded-full bg-indigo-500 animate-pulse flex items-center justify-center text-4xl font-bold shadow-2xl">?</div>
            <div class="absolute -bottom-2 -right-2 bg-green-500 w-8 h-8 rounded-full border-4 border-indigo-950"></div>
        </div>
        <h2 id="call-name-label" class="text-2xl font-bold mt-8 text-center px-4">User</h2>
        <p id="call-status-label" class="mt-2 opacity-50 tracking-widest uppercase text-xs font-black">Connecting...</p>
        
        <div class="flex gap-12 mt-16">
            <div id="receiver-actions" class="hidden flex gap-12">
                <div class="flex flex-col items-center gap-2">
                    <button onclick="acceptIncomingCall()" class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center hover:bg-green-600 transition shadow-lg active:scale-90">
                        <i class="fa-solid fa-phone text-2xl"></i>
                    </button>
                    <span class="text-[10px] font-bold uppercase opacity-60">Answer</span>
                </div>
                <div class="flex flex-col items-center gap-2">
                    <button onclick="endCall()" class="w-16 h-16 bg-red-500 rounded-full flex items-center justify-center hover:bg-red-600 transition shadow-lg active:scale-90">
                        <i class="fa-solid fa-phone-slash text-2xl"></i>
                    </button>
                    <span class="text-[10px] font-bold uppercase opacity-60">Ignore</span>
                </div>
            </div>

            <div id="caller-actions" class="flex flex-col items-center gap-2">
                <button onclick="endCall()" class="w-16 h-16 bg-red-500 rounded-full flex items-center justify-center hover:bg-red-600 transition shadow-lg active:scale-90">
                    <i class="fa-solid fa-phone-slash text-2xl"></i>
                </button>
                <span id="hangup-label" class="text-[10px] font-bold uppercase opacity-60">Hang Up</span>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://aolxwzszsfvtqjbldcdd.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_vyNRd2NL0JTDuYFtgMBleQ_ot-BhqRt';
        const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentUser = null;
        let selectedFriend = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let stream = null;
        let activeCallRecord = null;
        let pendingFile = null;
        let allFriends = [];

        const EMOJIS = ['â¤ï¸', 'ðŸ˜‚', 'ðŸ”¥', 'ðŸ‘', 'ðŸ™Œ', 'âœ¨', 'ðŸ˜Š', 'ðŸ˜®', 'ðŸ˜¢', 'ðŸ™', 'ðŸ’¯', 'ðŸ‘‹', 'ðŸŽ‰', 'ðŸ’¡', 'âœ…', 'âŒ', 'ðŸ‘€', 'ðŸš€'];

        window.onload = async () => {
            const { data } = await client.auth.getSession();
            if (!data.session) { window.location.href = 'auth.html'; return; }
            currentUser = data.session.user;
            
            const displayName = currentUser.user_metadata?.display_name || currentUser.user_metadata?.full_name || currentUser.email;
            document.getElementById('my-name').innerText = displayName;
            document.getElementById('my-avatar').innerText = displayName[0].toUpperCase();
            
            initEmojiPicker();
            renderChats();
            setupRealtime();

            document.getElementById('msg-input').addEventListener('keypress', e => {
                if (e.key === 'Enter') sendTextMessage();
            });

            // Close emoji picker on click outside
            window.addEventListener('click', (e) => {
                const picker = document.getElementById('emoji-picker');
                if (!picker.contains(e.target) && !e.target.closest('button[onclick="toggleEmojiPicker()"]')) {
                    picker.style.display = 'none';
                }
            });
        };

        function initEmojiPicker() {
            const grid = document.getElementById('emoji-grid');
            EMOJIS.forEach(emoji => {
                const span = document.createElement('span');
                span.className = 'emoji-item';
                span.innerText = emoji;
                span.onclick = () => {
                    const input = document.getElementById('msg-input');
                    input.value += emoji;
                    input.focus();
                };
                grid.appendChild(span);
            });
        }

        function toggleEmojiPicker() {
            const picker = document.getElementById('emoji-picker');
            picker.style.display = picker.style.display === 'block' ? 'none' : 'block';
        }

        async function handleLogout() {
            await client.auth.signOut();
            window.location.href = 'index.html';
        }

        function switchTab(tab) {
            const list = document.getElementById('list-container');
            list.innerHTML = ''; 
            if (tab === 'chats') renderChats();
            else if (tab === 'search') renderSearch();
            else if (tab === 'requests') renderRequests();
        }

        async function renderChats() {
            const container = document.getElementById('list-container');
            container.innerHTML = '<div class="p-4 text-[10px] font-black text-slate-400 uppercase tracking-widest">Conversations</div>';
            
            const { data } = await client.from('friends').select('*, profiles!friends_friend_id_fkey(*)').eq('user_id', currentUser.id).eq('status', 'accepted');
            const { data: data2 } = await client.from('friends').select('*, profiles!friends_user_id_fkey(*)').eq('friend_id', currentUser.id).eq('status', 'accepted');
            
            allFriends = [...(data || []), ...(data2 || [])].map(f => f.profiles).filter(p => p !== null);
            
            if (allFriends.length === 0) {
                container.innerHTML += '<div class="p-12 text-center"><i class="fa-solid fa-ghost text-slate-200 text-3xl mb-3"></i><p class="text-slate-400 text-xs font-medium">No conversations yet.</p></div>';
                return;
            }

            displayFriends(allFriends);
        }

        function filterFriends() {
            const q = document.getElementById('friend-filter').value.toLowerCase();
            const filtered = allFriends.filter(f => f.username.toLowerCase().includes(q));
            displayFriends(filtered);
        }

        function displayFriends(list) {
            const container = document.getElementById('list-container');
            container.innerHTML = '<div class="p-4 text-[10px] font-black text-slate-400 uppercase tracking-widest">Conversations</div>';
            
            list.forEach(f => {
                const isSelected = selectedFriend?.id === f.id;
                const div = document.createElement('div');
                div.className = `px-4 py-3 flex items-center gap-3 cursor-pointer transition relative group ${isSelected ? 'bg-indigo-50/50' : 'hover:bg-slate-50'}`;
                div.innerHTML = `
                    <div class="w-11 h-11 rounded-xl bg-indigo-100 flex items-center justify-center text-indigo-600 font-bold shrink-0 transition group-hover:scale-105">${(f.username || 'U')[0].toUpperCase()}</div>
                    <div class="flex-1 truncate">
                        <div class="flex justify-between items-center mb-0.5">
                            <span class="font-bold text-slate-800 text-sm">${f.username}</span>
                        </div>
                        <div class="text-[10px] text-slate-400 truncate font-medium">Tap to start chatting</div>
                    </div>
                    ${isSelected ? '<div class="absolute right-0 top-0 bottom-0 w-1 bg-indigo-500 rounded-l-full"></div>' : ''}
                `;
                div.onclick = () => openChat(f);
                container.appendChild(div);
            });
        }

        function renderSearch() {
            const container = document.getElementById('list-container');
            container.innerHTML = `
                <div class="p-4 space-y-4 animate-fade-in">
                    <div class="flex gap-2">
                        <input id="search-input" type="text" placeholder="Type a username..." class="flex-1 px-4 py-2 bg-slate-100 rounded-xl outline-none text-xs border border-transparent focus:border-indigo-300 focus:bg-white transition">
                        <button onclick="performSearch()" class="bg-indigo-600 text-white p-2 rounded-xl hover:bg-indigo-700 transition"><i class="fa-solid fa-magnifying-glass text-xs"></i></button>
                    </div>
                    <div id="search-results" class="space-y-2"></div>
                </div>
            `;
            document.getElementById('search-input').focus();
        }

        async function performSearch() {
            const input = document.getElementById('search-input');
            const q = input.value.trim();
            const resDiv = document.getElementById('search-results');
            if (!q) return;

            resDiv.innerHTML = '<div class="text-center py-4"><i class="fa-solid fa-circle-notch fa-spin text-indigo-600"></i></div>';
            const { data } = await client.from('profiles').select('*').or(`username.ilike.%${q}%,email.ilike.%${q}%`).neq('id', currentUser.id).limit(10);

            if (!data?.length) {
                resDiv.innerHTML = '<p class="text-slate-400 text-[10px] text-center mt-4">No users found.</p>';
                return;
            }

            resDiv.innerHTML = data.map(u => `
                <div class="flex items-center justify-between p-3 bg-white border border-slate-100 rounded-xl hover:border-indigo-200 transition">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-lg bg-slate-100 flex items-center justify-center text-[10px] font-bold text-slate-500">${u.username[0].toUpperCase()}</div>
                        <span class="text-xs font-bold text-slate-700">${u.username}</span>
                    </div>
                    <button onclick="sendRequest('${u.id}')" class="text-[10px] bg-indigo-600 text-white px-3 py-1.5 rounded-lg font-black uppercase hover:bg-indigo-700 transition">Add</button>
                </div>
            `).join('');
        }

        async function sendRequest(fid) {
            const { error } = await client.from('friends').insert([{ user_id: currentUser.id, friend_id: fid, status: 'pending' }]);
            if (error) alert(error.code === '23505' ? "Request already sent!" : "Error: " + error.message);
            else alert("Friend request sent!");
        }

        async function renderRequests() {
            const container = document.getElementById('list-container');
            container.innerHTML = '<div class="p-4 text-[10px] font-black text-slate-400 uppercase tracking-widest">Incoming Requests</div>';
            const { data } = await client.from('friends').select('*, profiles!friends_user_id_fkey(*)').eq('friend_id', currentUser.id).eq('status', 'pending');
            
            if (!data?.length) {
                container.innerHTML += '<p class="p-8 text-center text-slate-400 text-[10px] font-medium italic">No new requests</p>';
                return;
            }

            data.forEach(r => {
                const div = document.createElement('div');
                div.className = "p-4 border-b border-slate-50 flex items-center justify-between animate-fade-in";
                div.innerHTML = `
                    <div class="text-xs font-bold text-slate-700">${r.profiles?.username || 'Unknown'}</div>
                    <div class="flex gap-2">
                        <button onclick="updateReq(${r.id}, 'accepted')" class="w-8 h-8 bg-green-500 text-white rounded-lg flex items-center justify-center"><i class="fa-solid fa-check text-xs"></i></button>
                        <button onclick="updateReq(${r.id}, 'declined')" class="w-8 h-8 bg-slate-200 text-slate-500 rounded-lg flex items-center justify-center"><i class="fa-solid fa-xmark text-xs"></i></button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        async function updateReq(id, status) {
            if (status === 'declined') await client.from('friends').delete().eq('id', id);
            else await client.from('friends').update({ status }).eq('id', id);
            renderRequests();
        }

        async function openChat(friend) {
            selectedFriend = friend;
            document.getElementById('no-chat').classList.add('hidden');
            document.getElementById('active-chat').classList.remove('hidden');
            document.getElementById('chat-name').innerText = friend.username;
            document.getElementById('chat-avatar').innerText = (friend.username || 'U')[0].toUpperCase();
            loadMessages();
            renderChats();
        }

        async function loadMessages() {
            const cid = [currentUser.id, selectedFriend.id].sort().join(':');
            const { data } = await client.from('messages').select('*').eq('chat_id', cid).order('created_at', { ascending: true });
            const container = document.getElementById('messages-container');
            container.innerHTML = '';
            data?.forEach(m => appendMsg(m));
            container.scrollTop = container.scrollHeight;
        }

        function appendMsg(m) {
            const container = document.getElementById('messages-container');
            const isMe = m.sender_id === currentUser.id;
            const time = new Date(m.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            const div = document.createElement('div');
            div.className = `flex flex-col ${isMe ? 'items-end' : 'items-start'} animate-fade-in group`;
            
            let contentHtml = '';
            if (m.type === 'voice') {
                contentHtml = `
                    <div class="p-3 ${isMe ? 'message-out' : 'message-in'}">
                        <button onclick="playVoice(this, '${m.content}')" class="flex items-center gap-3">
                            <i class="fa-solid fa-play"></i>
                            <span class="text-xs font-bold uppercase tracking-wider">Voice Note</span>
                        </button>
                    </div>
                `;
            } else if (m.type === 'image') {
                contentHtml = `<div class="p-1 ${isMe ? 'message-out' : 'message-in'}"><img src="${m.content}" class="img-preview" onclick="window.open(this.src)"></div>`;
            } else {
                contentHtml = `<div class="p-3 ${isMe ? 'message-out' : 'message-in text-slate-700'} text-sm font-medium leading-relaxed">${m.content}</div>`;
            }

            div.innerHTML = `
                ${contentHtml}
                <div class="flex items-center gap-1 mt-1 opacity-0 group-hover:opacity-100 transition-opacity">
                    <span class="text-[9px] text-slate-400 font-bold">${time}</span>
                    ${isMe ? '<i class="fa-solid fa-check-double text-[9px] text-indigo-400"></i>' : ''}
                </div>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                pendingFile = event.target.result;
                document.getElementById('attachment-preview').classList.remove('hidden');
                document.getElementById('file-name-preview').innerText = file.name;
            };
            reader.readAsDataURL(file);
        }

        function clearAttachment() {
            pendingFile = null;
            document.getElementById('file-input').value = '';
            document.getElementById('attachment-preview').classList.add('hidden');
        }

        async function sendTextMessage() {
            const inp = document.getElementById('msg-input');
            const content = inp.value.trim();
            if ((!content && !pendingFile) || !selectedFriend) return;
            
            // Hide picker if open
            document.getElementById('emoji-picker').style.display = 'none';

            const cid = [currentUser.id, selectedFriend.id].sort().join(':');
            
            if (pendingFile) {
                await client.from('messages').insert([{ 
                    chat_id: cid, 
                    sender_id: currentUser.id, 
                    content: pendingFile, 
                    type: 'image' 
                }]);
                clearAttachment();
            }

            if (content) {
                await client.from('messages').insert([{ chat_id: cid, sender_id: currentUser.id, content }]);
                inp.value = '';
            }
        }

        function setupRealtime() {
            client.channel('chat-room').on('postgres_changes', { event: 'INSERT', table: 'messages' }, p => {
                const cid = [currentUser.id, selectedFriend?.id].sort().join(':');
                if (p.new.chat_id === cid) appendMsg(p.new);
            }).subscribe();

            client.channel('calls-room').on('postgres_changes', { event: '*', table: 'calls' }, payload => {
                handleCallSignal(payload);
            }).subscribe();
        }

        // --- CALLING LOGIC ---
        async function startCall() { 
            if (!selectedFriend) return;
            const { data: existing } = await client.from('calls').select('*').eq('caller_id', selectedFriend.id).eq('receiver_id', currentUser.id).maybeSingle();
            if (existing && existing.status === 'ringing') { activeCallRecord = existing; acceptIncomingCall(); return; }

            const { data } = await client.from('calls').upsert([{ caller_id: currentUser.id, receiver_id: selectedFriend.id, status: 'ringing' }], { onConflict: 'caller_id,receiver_id' }).select().single();
            activeCallRecord = data;
            showCallUI('outgoing', selectedFriend);
        }

        async function handleCallSignal(payload) {
            const call = payload.new || payload.old;
            if (!call) return;
            if (call.receiver_id === currentUser.id && payload.eventType === 'INSERT' && call.status === 'ringing') {
                activeCallRecord = call;
                const { data } = await client.from('profiles').select('*').eq('id', call.caller_id).single();
                showCallUI('incoming', data);
            }
            if (call.status === 'active' && (call.caller_id === currentUser.id || call.receiver_id === currentUser.id)) {
                activeCallRecord = call;
                setCallStatusUI('active');
            }
            if (call.status === 'ended' && (call.caller_id === currentUser.id || call.receiver_id === currentUser.id)) closeCallUI();
        }

        function showCallUI(type, person) {
            const overlay = document.getElementById('call-overlay');
            overlay.classList.remove('hidden');
            document.getElementById('call-avatar-circle').innerText = (person.username || '?')[0].toUpperCase();
            document.getElementById('call-name-label').innerText = person.username;

            if (type === 'incoming') {
                document.getElementById('call-status-label').innerText = 'Incoming Call...';
                document.getElementById('receiver-actions').classList.remove('hidden');
                document.getElementById('caller-actions').classList.add('hidden');
                overlay.classList.add('incoming-call-anim');
            } else {
                document.getElementById('call-status-label').innerText = 'Calling...';
                document.getElementById('receiver-actions').classList.add('hidden');
                document.getElementById('caller-actions').classList.remove('hidden');
                document.getElementById('hangup-label').innerText = 'Cancel';
                overlay.classList.remove('incoming-call-anim');
            }
        }

        function setCallStatusUI(state) {
            if (state === 'active') {
                document.getElementById('call-status-label').innerText = 'Call Active';
                document.getElementById('call-status-label').classList.add('text-green-400');
                document.getElementById('receiver-actions').classList.add('hidden');
                document.getElementById('caller-actions').classList.remove('hidden');
                document.getElementById('hangup-label').innerText = 'End Call';
                document.getElementById('call-overlay').classList.remove('incoming-call-anim');
            }
        }

        async function acceptIncomingCall() {
            if (!activeCallRecord) return;
            await client.from('calls').update({ status: 'active' }).eq('id', activeCallRecord.id);
            setCallStatusUI('active');
        }

        async function endCall() {
            if (activeCallRecord) await client.from('calls').update({ status: 'ended' }).eq('id', activeCallRecord.id);
            closeCallUI();
        }

        function closeCallUI() {
            document.getElementById('call-overlay').classList.add('hidden');
            document.getElementById('call-status-label').classList.remove('text-green-400');
            activeCallRecord = null;
        }

        function playVoice(btn, dataUrl) {
            const icon = btn.querySelector('i');
            const audio = new Audio(dataUrl);
            icon.className = 'fa-solid fa-spinner fa-spin';
            audio.play();
            audio.onplay = () => icon.className = 'fa-solid fa-pause';
            audio.onended = () => icon.className = 'fa-solid fa-play';
        }

        const mic = document.getElementById('mic-btn');
        async function startRecording() {
            try {
                audioChunks = [];
                stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.ondataavailable = e => { if (e.data.size > 0) audioChunks.push(e.data); };
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const reader = new FileReader();
                    reader.readAsDataURL(audioBlob);
                    reader.onloadend = async () => {
                        const cid = [currentUser.id, selectedFriend.id].sort().join(':');
                        await client.from('messages').insert([{ chat_id: cid, sender_id: currentUser.id, content: reader.result, type: 'voice' }]);
                    };
                    stream.getTracks().forEach(t => t.stop());
                };
                mediaRecorder.start();
                mic.classList.add('bg-red-500', 'text-white', 'recording-pulse');
            } catch (err) { alert("Mic access denied."); }
        }
        function stopRecording() {
            if (mediaRecorder?.state !== 'inactive') {
                mediaRecorder.stop();
                mic.classList.remove('bg-red-500', 'text-white', 'recording-pulse');
            }
        }
        mic.addEventListener('pointerdown', e => { e.preventDefault(); startRecording(); });
        window.addEventListener('pointerup', () => stopRecording());

    </script>
</body>
</html>
